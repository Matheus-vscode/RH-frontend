<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema RH • CIPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100">
<div id="root"></div>

<!-- React + Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

const API = "http://localhost:3001"; // endereço do backend

/* Sidebar, Dashboard, Employees, AwayList, CipaReport, EmployeeModal */
/* (mantenha exatamente os mesmos componentes que você já tinha no seu código atual)
   não precisa mexer neles, só trocamos o App lá embaixo.
*/

/* ================== App (com backend) ================== */
function App(){
  const [view, setView] = useState("dashboard");
  const [employees, setEmployees] = useState([]);
  const [away, setAway] = useState([]);
  const [search, setSearch] = useState("");
  const [showModal, setShowModal] = useState(false);
  const [formData, setFormData] = useState({id:"", name:"", cpf:"", role:"", dept:"", salary:"", adm:""});

  // Carregar dados do backend
  useEffect(()=> {
    fetch(`${API}/employees`)
      .then(res => res.json())
      .then(data => setEmployees(data))
      .catch(err => console.error("Erro carregando funcionários:", err));

    fetch(`${API}/away`)
      .then(res => res.json())
      .then(data => setAway(data))
      .catch(err => console.error("Erro carregando afastamentos:", err));
  }, []);

  const filteredEmployees = employees.filter(e => e.name.toLowerCase().includes(search.toLowerCase()));
  const currentAway = away.filter(a => {
    const now = new Date();
    const f = new Date(a.fromDate);
    const t = a.toDate ? new Date(a.toDate) : f;
    return f <= now && now <= t;
  });

  // Salvar funcionário
  const handleSave = async e => {
    e.preventDefault();
    if (!formData.name) return;

    try {
      if (formData.id) {
        await fetch(`${API}/employees/${formData.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });
      } else {
        const res = await fetch(`${API}/employees`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });
        const newEmp = await res.json();
        setEmployees([...employees, newEmp]);
      }
      const resAll = await fetch(`${API}/employees`);
      setEmployees(await resAll.json());

      setFormData({id:"", name:"", cpf:"", role:"", dept:"", salary:"", adm:""});
      setShowModal(false);
    } catch(err) {
      console.error("Erro salvando funcionário:", err);
    }
  };

  // Deletar funcionário
  const handleDelete = async id => {
    if (!confirm("Remover funcionário?")) return;
    await fetch(`${API}/employees/${id}`, { method: "DELETE" });
    await fetch(`${API}/away/employee/${id}`, { method: "DELETE" });
    setEmployees(employees.filter(e => e.id !== id));
    setAway(away.filter(a => a.empId !== id));
  };

  // Editar
  const handleEdit = emp => { setFormData(emp); setShowModal(true); };

  // Registrar afastamento
  const registerAway = async empId => {
    const fromDate = prompt("Data início (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
    if (!fromDate) return;
    const toDate = prompt("Data fim (opcional):", "");
    const reason = prompt("Motivo/CID:", "CID-10 F32 - Depressão");

    const res = await fetch(`${API}/away`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ empId, fromDate, toDate: toDate || null, reason })
    });
    const newAway = await res.json();
    setAway([...away, newAway]);
  };

  // Remover afastamento
  const removeAway = async id => {
    await fetch(`${API}/away/${id}`, { method: "DELETE" });
    setAway(away.filter(a => a.id !== id));
  };

  return (
    <div className="flex min-h-screen">
      <Sidebar view={view} setView={setView} search={search} setSearch={setSearch} onAdd={()=>setShowModal(true)} employees={employees} away={away}/>
      <main className="flex-1 p-6 overflow-y-auto">
        {view==="dashboard" && <Dashboard employees={employees} currentAway={currentAway} />}
        {view==="funcionarios" && <Employees filteredEmployees={filteredEmployees} onEdit={handleEdit} onDelete={handleDelete} onAway={registerAway} />}
        {view==="ferias" && <AwayList away={away} employees={employees} onRemove={removeAway} />}
        {view==="cipa" && <CipaReport away={away} />}
      </main>

      <EmployeeModal show={showModal} onClose={()=>setShowModal(false)} formData={formData} setFormData={setFormData} onSave={handleSave} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>


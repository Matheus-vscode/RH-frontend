<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema RH ‚Ä¢ CIPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100">
<div id="root"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ================== LOGIN ================== */
function Login({ onLogin }) {
  const [usuario, setUsuario] = useState("");
  const [senha, setSenha] = useState("");
  const [erro, setErro] = useState("");
  const [tentativas, setTentativas] = useState(0);
  const maxTentativas = 3;

  const handleSubmit = (e) => {
    e.preventDefault();
    if(tentativas >= maxTentativas) {
      setErro("Conta bloqueada ap√≥s 3 tentativas.");
      return;
    }
    if (usuario === "admin" && senha === "1234") {
      onLogin();
    } else {
      setTentativas(prev => prev + 1);
      setErro(Usu√°rio ou senha inv√°lidos. Tentativa ${tentativas+1} de ${maxTentativas}.);
    }
  };

  return (
    <div className="flex items-center justify-center h-screen bg-gradient-to-r from-cyan-700 to-purple-800">
      <div className="bg-slate-900 p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h1 className="text-2xl font-bold text-cyan-400 text-center mb-6">üîê Acesso ao Sistema RH ‚Ä¢ CIPA</h1>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block mb-1 font-semibold">Usu√°rio</label>
            <input
              type="text"
              value={usuario}
              onChange={(e) => setUsuario(e.target.value)}
              className="w-full px-3 py-2 rounded-lg bg-slate-800 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
              placeholder="Digite seu usu√°rio"
              disabled={tentativas>=maxTentativas}
            />
          </div>
          <div>
            <label className="block mb-1 font-semibold">Senha</label>
            <input
              type="password"
              value={senha}
              onChange={(e) => setSenha(e.target.value)}
              className="w-full px-3 py-2 rounded-lg bg-slate-800 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
              placeholder="Digite sua senha"
              disabled={tentativas>=maxTentativas}
            />
          </div>
          {erro && <p className="text-red-500 text-sm">{erro}</p>}
          <button type="submit" className="w-full py-2 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-lg font-semibold hover:scale-105 transition" disabled={tentativas>=maxTentativas}>
            Entrar
          </button>
        </form>

        <div className="mt-6 text-sm text-slate-300">
          <h3 className="font-bold text-cyan-400 mb-2">üìå Instru√ß√µes de acesso:</h3>
          <ul className="list-disc pl-5 space-y-1">
            <li>Usu√°rio padr√£o: <b>admin</b></li>
            <li>Senha padr√£o: <b>1234</b></li>
            <li>Ap√≥s 3 tentativas incorretas, o sistema bloqueia.</li>
            <li>Entre em contato com o administrador para suporte.</li>
          </ul>
        </div>
      </div>
    </div>
  );
}

/* ================== Export CSV ================== */
function exportCSV(filename, rows) {
  if (!rows || !rows.length) return alert("Nada para exportar.");
  const separator = ";";
  const keys = Object.keys(rows[0]);
  const csvContent = [ keys.join(separator), ...rows.map(r => keys.map(k => (r[k] ?? "")).join(separator)) ].join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.click();
}

/* ================== Sidebar ================== */
function Sidebar({ view, setView, search, setSearch, onAdd, employees, away }) {
  return (
    <aside className="w-64 p-4 border-r border-slate-800 flex flex-col bg-slate-900">
      <h1 className="text-2xl font-bold text-cyan-400 mb-6">RH ‚Ä¢ Sistema</h1>

      <input
        type="text"
        placeholder="Pesquisar funcion√°rio..."
        className="w-full mb-4 px-3 py-2 rounded-lg bg-slate-800 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400"
        value={search}
        onChange={e => setSearch(e.target.value)}
      />

      <nav className="flex flex-col gap-2 mb-6">
        {["dashboard","funcionarios","ferias","cipa"].map(v => (
          <button
            key={v}
            onClick={() => setView(v)}
            className={`text-left px-3 py-2 rounded-lg transition flex items-center gap-2 ${
              view===v ? "bg-gradient-to-r from-cyan-500 to-purple-600 text-white font-semibold shadow-lg"
                      : "text-slate-400 hover:text-white hover:bg-slate-700"
            }`}
          >
            {v==="dashboard" && "Dashboard"}
            {v==="funcionarios" && "Funcion√°rios"}
            {v==="ferias" && "F√©rias / Afastamentos"}
            {v==="cipa" && "üìä Relatorio RH/CIPA"}
          </button>
        ))}
      </nav>

      <div className="space-y-2 mb-4">
        <button
          className="w-full px-3 py-2 bg-gradient-to-r from-cyan-500 to-purple-600 text-white rounded-lg hover:scale-105 transition shadow-md font-semibold"
          onClick={() => exportCSV("funcionarios.csv", employees)}
        >
          ‚¨á Exportar Funcion√°rios
        </button>

        <button
          className="w-full px-3 py-2 bg-gradient-to-r from-cyan-500 to-purple-600 text-white rounded-lg hover:scale-105 transition shadow-md font-semibold"
          onClick={() => exportCSV("afastamentos.csv", away)}
        >
          ‚¨á Exportar Afastamentos
        </button>
      </div>

      <button
        className="mt-auto w-full bg-gradient-to-r from-cyan-500 to-purple-600 text-white py-2 rounded-xl hover:scale-105 transition font-semibold"
        onClick={onAdd}
      >
        + Novo funcion√°rio
      </button>
    </aside>
  );
}

/* ================== Dashboard ================== */
function Dashboard({ employees, currentAway }) {
  return (
    <div className="grid md:grid-cols-3 gap-4">
      <div className="bg-slate-800 p-6 rounded-2xl shadow-lg">
        <p className="text-slate-400">Colaboradores</p>
        <p className="text-3xl font-bold">{employees.length}</p>
      </div>
      <div className="bg-slate-800 p-6 rounded-2xl shadow-lg">
        <p className="text-slate-400">Em f√©rias/afastados</p>
        <p className="text-3xl font-bold">{currentAway.length}</p>
      </div>
      <div className="bg-slate-800 p-6 rounded-2xl shadow-lg">
        <p className="text-slate-400">√öltimo acesso</p>
        <p className="text-lg">{new Date().toLocaleDateString("pt-BR")}</p>
      </div>
    </div>
  );
}

/* ================== Employees ================== */
function Employees({ filteredEmployees, onEdit, onDelete, onAway }) {
  return filteredEmployees.length === 0 ? (
    <p className="text-slate-400">Nenhum funcion√°rio cadastrado.</p>
  ) : (
    <table className="w-full text-left border-collapse rounded-xl overflow-hidden shadow-lg">
      <thead>
        <tr className="bg-slate-800">
          <th className="p-2 text-slate-200">Nome</th>
          <th className="p-2 text-slate-200">CPF</th>
          <th className="p-2 text-slate-200">Cargo</th>
          <th className="p-2 text-slate-200">Departamento</th>
          <th className="p-2 text-slate-200">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {filteredEmployees.map(e => (
          <tr key={e.id} className="border-b border-slate-800 hover:bg-slate-700 transition">
            <td className="p-2">{e.name}</td>
            <td className="p-2">{e.cpf}</td>
            <td className="p-2">{e.role}</td>
            <td className="p-2">{e.dept}</td>
            <td className="p-2 flex gap-2">
              <button className="px-3 py-1 bg-slate-700 rounded hover:bg-cyan-600 transition" onClick={()=>onEdit(e)}>Editar</button>
              <button className="px-3 py-1 bg-red-600 rounded hover:bg-red-500 transition" onClick={()=>onDelete(e.id)}>Remover</button>
              <button className="px-3 py-1 bg-cyan-600 rounded hover:bg-cyan-500 transition" onClick={()=>onAway(e.id)}>Afastar</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}

/* ================== AwayList ================== */
function AwayList({ away, employees, onRemove, onEdit }) {
  if (!away.length) return <p className="text-slate-400">Nenhum afastamento registrado.</p>;
  return (
    <ul className="space-y-2">
      {away.map(a => {
        const emp = employees.find(e => e.id === a.empId);
        return (
          <li key={a.id} className="bg-slate-800 p-4 rounded-xl flex justify-between items-center shadow-md">
            <div>
              <p className="font-semibold">{emp?.name || "[Ex-funcion√°rio]"}</p>
              <p className="text-slate-400 text-sm">{a.reason} ‚Äî {a.fromDate} {a.toDate ? at√© ${a.toDate} : ""}</p>
            </div>
            <div className="flex gap-2">
              <button className="px-3 py-1 bg-yellow-600 rounded hover:bg-yellow-500 transition" onClick={()=>onEdit(a)}>Editar</button>
              <button className="px-3 py-1 bg-red-600 rounded hover:bg-red-500 transition" onClick={() => onRemove(a.id)}>Remover</button>
            </div>
          </li>
        );
      })}
    </ul>
  );
}

/* ================== CIPA Report ================== */
function CipaReport({ away }) {
  if (!away.length) return <p className="text-slate-400">Nenhum afastamento registrado.</p>;

  const stats = away.reduce((acc, a) => {
    const cid = a.reason || "N√£o informado";
    acc[cid] = (acc[cid] || 0) + 1;
    return acc;
  }, {});

  const alertas = [];
  const rowColors = {};

  Object.keys(stats).forEach(cid => {
    const cLower = cid.toLowerCase();
    if (cLower.includes("depress") || cLower.includes("f32") || cLower.includes("psic")) {
      alertas.push(‚ö† CID "${cid}": poss√≠vel problema psicol√≥gico. A√ß√£o: apoio psicol√≥gico/palestra.);
      rowColors[cid] = "bg-yellow-100 text-yellow-900";
    } else if (cLower.includes("acidente") || cLower.includes("s72") || cLower.includes("trauma")) {
      alertas.push(‚ö† CID "${cid}": acidente de trabalho. A√ß√£o: revisar seguran√ßa.);
      rowColors[cid] = "bg-red-100 text-red-900";
    } else {
      rowColors[cid] = "bg-slate-700 text-slate-100";
    }
  });

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-cyan-400 mb-4">üìä Relatorio RH/CIPA</h2>

      <div className="overflow-x-auto">
        <table className="min-w-full border border-slate-700 rounded-lg overflow-hidden">
          <thead className="bg-slate-800 text-slate-300">
            <tr>
              <th className="px-4 py-2 text-left">CID / Motivo</th>
              <th className="px-4 py-2 text-left">Quantidade</th>
            </tr>
          </thead>
          <tbody>
            {Object.entries(stats).map(([cid, qtd], i) => (
              <tr key={i} className={${rowColors[cid] || "bg-slate-700 text-white"} border-b border-slate-600}>
                <td className="px-4 py-2">{cid}</td>
                <td className="px-4 py-2">{qtd}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {alertas.length > 0 && (
        <div className="bg-red-600/20 border border-red-500 rounded-lg p-4 space-y-2 text-white">
          <h3 className="font-bold text-lg">‚ö† Recomenda√ß√µes:</h3>
          <ul className="list-disc pl-5 space-y-1">
            {alertas.map((a,i) => <li key={i}>{a}</li>)}
          </ul>
          <p className="mt-2 text-sm">Encaminhar ao RH e √† CIPA para an√°lise. Implementar a√ß√µes preventivas conforme o tipo de afastamento.</p>
        </div>
      )}
    </div>
  );
}

/* ================== Employee Modal ================== */
function EmployeeModal({ show, onClose, formData, setFormData, onSave }) {
  const [tab, setTab] = useState("dados");
  const modalRef = useRef();

  const handleClickOutside = (e) => {
    if(modalRef.current && !modalRef.current.contains(e.target)) onClose();
  };

  useEffect(()=> {
    document.addEventListener("mousedown", handleClickOutside);
    return ()=> document.removeEventListener("mousedown", handleClickOutside);
  });

  if (!show) return null;

  const handleSubmit = (e) => {
    e.preventDefault();
    if(!formData.name || !formData.cpf || !formData.role || !formData.dept){
      alert("Preencha os campos obrigat√≥rios: Nome, CPF, Cargo e Departamento.");
      return;
    }
    onSave(e);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <form ref={modalRef} onSubmit={handleSubmit} className="bg-slate-800 p-6 rounded-2xl w-full max-w-lg space-y-4 shadow-lg text-white">
        <h3 className="text-xl font-bold">{formData.id ? "Editar Funcion√°rio" : "Novo Funcion√°rio"}</h3>

        <div className="flex gap-2 mb-4">
          <button type="button" onClick={()=>setTab("dados")} className={px-3 py-1 rounded ${tab==="dados" ? "bg-cyan-500 text-white" : "bg-slate-700 text-slate-200"}}>Dados</button>
          <button type="button" onClick={()=>setTab("financeiro")} className={px-3 py-1 rounded ${tab==="financeiro" ? "bg-cyan-500 text-white" : "bg-slate-700 text-slate-200"}}>Financeiro</button>
        </div>

        {tab==="dados" && (
          <div className="space-y-3">
            <div><label className="block mb-1 font-semibold">Nome *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">CPF *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" value={formData.cpf} onChange={e => setFormData({...formData, cpf: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">Cargo *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">Departamento *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" value={formData.dept} onChange={e => setFormData({...formData, dept: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">Data de admiss√£o</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="date" value={formData.adm} onChange={e => setFormData({...formData, adm: e.target.value})} /></div>
          </div>
        )}

        {tab==="financeiro" && (
          <div className="space-y-3">
            <div><label className="block mb-1 font-semibold">Sal√°rio</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="number" value={formData.salary} onChange={e => setFormData({...formData, salary: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">Folha</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" placeholder="Ex: Mensal, Quinzenal" value={formData.payroll || ""} onChange={e => setFormData({...formData, payroll: e.target.value})} /></div>
            <div><label className="block mb-1 font-semibold">Benef√≠cios</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" placeholder="Vale transporte, VR/VA, etc." value={formData.benefits || ""} onChange={e => setFormData({...formData, benefits: e.target.value})} /></div>
          </div>
        )}

        <div className="flex justify-end gap-2">
          <button type="button" className="px-3 py-1 bg-slate-600 rounded hover:bg-slate-500 transition" onClick={onClose}>Cancelar</button>
          <button type="submit" className="px-3 py-1 bg-gradient-to-r from-cyan-500 to-purple-600 rounded hover:opacity-90 transition">Salvar</button>
        </div>
      </form>
    </div>
  );
}

/* ================== Away Modal ================== */
function AwayModal({ show, onClose, formData, setFormData, onSave, employees }) {
  const modalRef = useRef();

  const handleClickOutside = (e) => {
    if(modalRef.current && !modalRef.current.contains(e.target)) onClose();
  };

  useEffect(()=> {
    document.addEventListener("mousedown", handleClickOutside);
    return ()=> document.removeEventListener("mousedown", handleClickOutside);
  });

  if (!show) return null;

  const handleSubmit = e => {
    e.preventDefault();
    if(!formData.reason || !formData.fromDate){
      alert("Preencha os campos obrigat√≥rios: Motivo e Data in√≠cio.");
      return;
    }
    onSave(e);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <form ref={modalRef} onSubmit={handleSubmit} className="bg-slate-800 p-6 rounded-2xl w-full max-w-lg space-y-4 shadow-lg text-white">
        <h3 className="text-xl font-bold">{formData.id ? "Editar Afastamento" : "Novo Afastamento"}</h3>

        <div className="space-y-3">
          <div>
            <label className="block mb-1 font-semibold">Funcion√°rio *</label>
            <select className="w-full p-2 rounded bg-slate-700 text-white" value={formData.empId} onChange={e=>setFormData({...formData, empId:e.target.value})} required>
              <option value="">Selecione...</option>
              {employees.map(emp=><option key={emp.id} value={emp.id}>{emp.name}</option>)}
            </select>
          </div>
          <div><label className="block mb-1 font-semibold">Motivo / CID *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="text" value={formData.reason} onChange={e => setFormData({...formData, reason:e.target.value})} /></div>
          <div><label className="block mb-1 font-semibold">Data in√≠cio *</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="date" value={formData.fromDate} onChange={e => setFormData({...formData, fromDate:e.target.value})} /></div>
          <div><label className="block mb-1 font-semibold">Data fim (opcional)</label><input className="w-full p-2 rounded bg-slate-700 text-white" type="date" value={formData.toDate || ""} onChange={e => setFormData({...formData, toDate:e.target.value})} /></div>
        </div>

        <div className="flex justify-end gap-2">
          <button type="button" className="px-3 py-1 bg-slate-600 rounded hover:bg-slate-500 transition" onClick={onClose}>Cancelar</button>
          <button type="submit" className="px-3 py-1 bg-gradient-to-r from-cyan-500 to-purple-600 rounded hover:opacity-90 transition">Salvar</button>
        </div>
      </form>
    </div>
  );
}

/* ================== APP ================== */
function App(){
  const [view, setView] = useState("dashboard");
  const [employees, setEmployees] = useState([]);
  const [away, setAway] = useState([]);
  const [search, setSearch] = useState("");
  const [showEmpModal, setShowEmpModal] = useState(false);
  const [showAwayModal, setShowAwayModal] = useState(false);
  const [empForm, setEmpForm] = useState({id:"", name:"", cpf:"", role:"", dept:"", salary:"", adm:"", payroll:"", benefits:""});
  const [awayForm, setAwayForm] = useState({id:"", empId:"", reason:"", fromDate:"", toDate:""});

  useEffect(()=> {
    const empLS = localStorage.getItem("employees");
    if (empLS) setEmployees(JSON.parse(empLS));
    const awayLS = localStorage.getItem("away");
    if (awayLS) setAway(JSON.parse(awayLS));
  }, []);

  useEffect(()=> localStorage.setItem("employees", JSON.stringify(employees)), [employees]);
  useEffect(()=> localStorage.setItem("away", JSON.stringify(away)), [away]);

  const filteredEmployees = employees.filter(e => e.name.toLowerCase().includes(search.toLowerCase()));
  const currentAway = away.filter(a => {
    const now = new Date();
    const f = new Date(a.fromDate);
    const t = a.toDate ? new Date(a.toDate) : f;
    return f <= now && now <= t;
  });

  /* ======= Funcionario ======= */
  const handleSaveEmp = e => {
    e.preventDefault();
    const newData = {...empForm, salary: parseFloat(empForm.salary) || 0};
    if (empForm.id) {
      setEmployees(employees.map(emp => emp.id === empForm.id ? newData : emp));
    } else {
      setEmployees([...employees, {...newData, id: crypto.randomUUID()}]);
    }
    setEmpForm({id:"", name:"", cpf:"", role:"", dept:"", salary:"", adm:"", payroll:"", benefits:""});
    setShowEmpModal(false);
    alert("Funcion√°rio salvo com sucesso!");
  };
  const handleEditEmp = e => { setEmpForm(e); setShowEmpModal(true); };
  const handleDeleteEmp = id => { if(confirm("Remover funcion√°rio?")) setEmployees(employees.filter(e=>e.id!==id)); };

  /* ======= Afastamento ======= */
  const handleAddAway = empId => {
    setAwayForm({id:"", empId, reason:"", fromDate:new Date().toISOString().slice(0,10), toDate:""});
    setShowAwayModal(true);
  };
  const handleEditAway = a => { setAwayForm(a); setShowAwayModal(true); };
  const handleSaveAway = e => {
    e.preventDefault();
    if (awayForm.id) {
      setAway(away.map(a=>a.id===awayForm.id?awayForm:a));
    } else {
      setAway([...away,{...awayForm,id:crypto.randomUUID()}]);
    }
    setAwayForm({id:"", empId:"", reason:"", fromDate:"", toDate:""});
    setShowAwayModal(false);
    alert("Afastamento salvo com sucesso!");
  };
  const handleRemoveAway = id => setAway(away.filter(a=>a.id!==id));

  return (
    <div className="flex h-screen">
      <Sidebar view={view} setView={setView} search={search} setSearch={setSearch} onAdd={()=>setShowEmpModal(true)} employees={employees} away={away}/>
      <main className="flex-1 p-6 overflow-auto">
        {view==="dashboard" && <Dashboard employees={employees} currentAway={currentAway}/>}
        {view==="funcionarios" && <Employees filteredEmployees={filteredEmployees} onEdit={handleEditEmp} onDelete={handleDeleteEmp} onAway={handleAddAway}/>}
        {view==="ferias" && <AwayList away={away} employees={employees} onRemove={handleRemoveAway} onEdit={handleEditAway}/>}
        {view==="cipa" && <CipaReport away={away}/>}
      </main>
      <EmployeeModal show={showEmpModal} onClose={()=>setShowEmpModal(false)} formData={empForm} setFormData={setEmpForm} onSave={handleSaveEmp}/>
      <AwayModal show={showAwayModal} onClose={()=>setShowAwayModal(false)} formData={awayForm} setFormData={setAwayForm} onSave={handleSaveAway} employees={employees}/>
    </div>
  );
}

/* ================== Root com Login ================== */
function Root(){
  const [logged, setLogged] = useState(false);
  return logged ? <App/> : <Login onLogin={()=>setLogged(true)}/>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<Root/>);
</script>
</body>
</html>